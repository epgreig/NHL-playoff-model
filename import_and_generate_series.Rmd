---
title: "import_and_generate_series"
author: "Ethan Greig"
date: "1/18/2019"
output: html_document
---

## Import Raw Team Data

# import from morehockeystats: ENGF, ENGA, B-S stats, Time_Led (set custom format h:mm, calc *1440, /60)
#   *move WPG for ATL years, and move ARI for 2015
# import from natural stat trick: W, ROW, HDCF%_55
# import from Fox Sports: PP%, PK% (paste as text, text->columns w/ tab delim)
```{r}
corsica_55 <- read.csv("input_csvs/corsica_5v5_08-18.csv", check.names=FALSE)
corsica_55$Season <- strtoi(substr(corsica_55$Season, 6, 9))
corsica_55 <- corsica_55[, c('Team', 'Season', 'CF%_55', 'CF/60_55', 'CA/60_55', 'GF%_55', 'GF/60_55', 'GA/60_55', 'xGF%_55', 'xGF/60_55', 'xGA/60_55', 'Sh%_55', 'Sv%_55')]

corsica_all <- read.csv("input_csvs/corsica_all_08-18.csv", check.names=FALSE)
corsica_all$Season <- strtoi(substr(corsica_all$Season, 6, 9))
corsica_all <- corsica_all[, c('Team', 'Season', 'CF%_all', 'CF/60_all', 'CA/60_all', 'GF_all', 'GA_all', 'GF%_all', 'GF/60_all', 'GA/60_all', 'xGF%_all', 'xGF/60_all', 'xGA/60_all', 'Sh%_all', 'Sv%_all')]

other_data <- read.csv("input_csvs/misc_stats_08-18.csv", check.names=FALSE)
other_data <- other_data[, c('Team', 'Season', 'HDCF%_55', 'Time_Led', 'ENGF', 'ENGA', 'PP%', 'PK%', 'W', 'ROW', 'Berg', 'xBerg')]

stats <- c('CF%_55', 'CF/60_55', 'CA/60_55', 'GF%_55', 'GF/60_55', 'GA/60_55', 'xGF%_55', 'xGF/60_55', 'xGA/60_55', 'Sh%_55', 'Sv%_55', 'CF%_all', 'CF/60_all', 'CA/60_all', 'GF%_all', 'ENGF', 'ENGA', 'GF/60_all', 'GA/60_all', 'xGF%_all', 'xGF/60_all', 'xGA/60_all', 'Sh%_all', 'Sv%_all', 'HDCF%_55', 'Time_Led', 'PP%', 'PK%', 'W', 'ROW', 'Berg', 'xBerg')

raw_stats <- merge(merge(corsica_55, corsica_all, by=c("Team", "Season")), other_data, by=c("Team", "Season"))
raw_stats <- raw_stats[, c('Team', 'Season', stats)]
raw_stats
```


## Create Matchups
```{r}
dStats <- stats
for (i in 1:length(stats)) {
  stat <- stats[i]
  dStat <- paste0('d', stat)
  dStats[i] <- dStat
}

dStats <- make.names(dStats)

# Import series data, add empty columns for stat differences
series <- read.csv("input_csvs/all_playoff_series.csv")
series = series[series$Season<2018,]
series$Home_Won <- round(series$Home_W., 0)
for(i in 1:length(dStats)) {
  dStat <- dStats[i]
  series[,dStat] <- NA
}

# define function to extract stat differences given two teams and a season
getDifferences <- function(row, df) {
  df_year <- df[df$Season==row$Season,]
  home_team <- df_year[as.character(df_year$Team)==as.character(row$Home),]
  away_team <- df_year[as.character(df_year$Team)==as.character(row$Away),]
  for (i in 1:length(stats)) {
    stat <- stats[i]
    dStat <- dStats[i]
    row[dStat] <- home_team[stat] - away_team[stat]
  }
  return(row)
}

# fill series data frame with stat differences from regular season
for (row in 1:nrow(series)) {
  series[row,] <- getDifferences(series[row,], raw_stats)
}

series
```

# Remove highly-correlated features
```{r}
corr <- cor(series[,c('Home_Won', dStats)])
corr_vars <- names(data.frame(corr))[which(corr>0.88 & corr<1, arr.ind = TRUE)[, "col"]]

# cor(series[,c('Home_Won', corr_vars)]) # Remove one feature from each highly-correlated pair
dStats <- dStats[!dStats%in%c('dCF._55', 'dCF.60_all', 'dCA._all', 'dBerg', 'dxGF.60_all', 'dSh._all')]
```


## Prepare dataframe
```{r}
df <- series[,c('Home_Won', dStats)] # keep only features and target
df[,dStats] <- data.frame(scale(df[,dStats])) # normalize
```
