---
title: "import_and_generate_series"
author: "Ethan Greig"
date: "1/18/2019"
output: html_document
---


```{r}
library(knitr)
source(purl('import_data.Rmd', output = tempfile()))
```


## Create Matchups
```{r}
dStats <- stats
for (i in 1:length(stats)) {
  stat <- stats[i]
  dStat <- paste0('d', stat)
  dStats[i] <- dStat
}

dStats <- make.names(dStats)

# Import series data, add empty columns for stat differences
series <- read.csv("input_csvs/all_playoff_series.csv")
series <- series[series$Season<2018,]
series$Home_Won <- round(series$Home_W., 0)
for(i in 1:length(dStats)) {
  dStat <- dStats[i]
  series[,dStat] <- NA
}

# define function to extract stat differences given two teams and a season
getDifferences <- function(row, df) {
  df_year <- df[df$Season==row$Season,]
  home_team <- df_year[as.character(df_year$Team)==as.character(row$Home),]
  away_team <- df_year[as.character(df_year$Team)==as.character(row$Away),]
  for (i in 1:length(stats)) {
    stat <- stats[i]
    dStat <- dStats[i]
    row[dStat] <- home_team[stat] - away_team[stat]
  }
  return(row)
}

# fill series data frame with stat differences from regular season
for (row in 1:nrow(series)) {
  series[row,] <- getDifferences(series[row,], raw_stats)
}

series
```

# Remove highly-correlated features
```{r}
corr <- cor(series[,c('Home_Won', dStats)])
corr_vars <- names(data.frame(corr))[which(corr>0.88 & corr<1, arr.ind = TRUE)[, "col"]]

cor(series[,c('Home_Won', corr_vars)]) # Remove one feature from each highly-correlated pair
dStats <- dStats[!dStats%in%c('dCF._55', 'dCF.60_all', 'dCA.60_all', 'dBerg', 'dxGF.60_all', 'dSh._all')]
```


## Prepare dataframe
```{r}
df <- series[,c('Home_Won', dStats)] # keep only features and target
df[,dStats] <- data.frame(scale(df[,dStats])) # normalize
```
